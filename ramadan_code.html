<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
         <script type="module" src="auth-guard.js"></script>
    <title>Order Page</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica', sans-serif;
            background-color: #f0f0f0;
            overflow-x: hidden;
            padding-bottom: 100px;
        }
		 /* Header */
        .header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: #0C0E8B;
            color: white;
            position: sticky;
            top: 20px;
            border-radius: 15px;
            width: calc(100% - 40px);
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .menu-icon {
            font-size: 30px;
            cursor: pointer;
        }

        .header img {
            width: 100px;
            height: 50px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Improved Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: linear-gradient(145deg, #0C0E8B, #1416a0);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            padding: 30px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar img {
            width: 120px;
            margin-right: 15px;
        }

        .sidebar .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .sidebar .user-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

     

        /* Container Styles */
        .container {
            width: 90%;
            max-width: 400px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            margin: 30px auto;
            padding: 25px;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(12, 14, 139, 0.1);
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(12, 14, 139, 0.15);
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #0C0E8B, #1416a0);
        }

        /* Calendar Container */
        .calendar-container {
            margin-bottom: 25px;
        }

        .calendar-container h2 {
            color: #0C0E8B;
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        #calendar {
            font-size: 1.2rem;
            color: #333;
            text-align: center;
            padding: 15px;
            background: rgba(12, 14, 139, 0.05);
            border-radius: 12px;
            margin-top: 10px;
        }

        /* Order Section */
        .order-section {
            padding: 20px;
            background: white;
            border-radius: 15px;
            text-align: center;
        }

        .order-question {
            font-size: 1.3rem;
            color: #0C0E8B;
            margin-bottom: 25px;
            font-weight: 500;
            text-align: center;
        }

        .order-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .order-buttons button {
            padding: 12px 35px;
            font-size: 1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .yes-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .yes-btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2);
        }

        .no-btn {
            background: linear-gradient(135deg, #dc3545, #f86b7d);
            color: white;
        }

        .no-btn:hover {
            background: linear-gradient(135deg, #f86b7d, #dc3545);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.2);
        }

        #submitOrder {
            display: none;
            background: linear-gradient(135deg, #5BA7E1, #4a90e2);
            color: white;
            padding: 15px 40px;
            font-size: 1.1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(91, 167, 225, 0.2);
            width: 80%;
            max-width: 300px;
        }

        #submitOrder:hover {
            background: linear-gradient(135deg, #4a90e2, #5BA7E1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(91, 167, 225, 0.3);
        }

        #time-message {
            margin-top: 15px;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            font-weight: 500;
        }

        /* Thank You Container */
        .thank-you-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none;
            z-index: 1000;
            min-width: 300px;
        }

        .thank-you-container h2 {
            color: #0C0E8B;
            margin-bottom: 15px;
        }

        .thank-you-container p {
            color: #666;
            margin-bottom: 20px;
        }

        .thank-you-container i {
            color: #28a745;
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                width: 95%;
                padding: 20px;
            }

            .order-buttons {
                flex-direction: column;
                gap: 15px;
            }

            .order-buttons button {
                width: 100%;
            }

            .thank-you-container {
                width: 90%;
                padding: 20px;
            }
        }
		 .nav-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background:  #0C0E8B;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 35px;
			width: calc(100% - 40px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #FFFFFF;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-item:hover {
            color: #2dd4bf;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-item span {
            font-size: 12px;
        }

        .plus-button {
            position: relative;
            width: 50px;
            height: 50px;
            background: #0C0E8B;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center;
            box-shadow: 0 4px 10px rgba(45, 212, 191, 0.3);
        }

        .plus-button.active {
            transform: rotate(45deg);
        }

        .floating-menu {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            transition: transform 0.3s;
            opacity: 0;
            pointer-events: none;
        }

        .floating-menu.active {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #777;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
        }

        .menu-item:hover {
            color: #000000;
        }

        .menu-item i {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .menu-item span {
            font-size: 12px;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;

        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
		 


        #qrcode {
            margin: 20px auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            width: fit-content;
        }

        .qr-instruction {
            color: #666;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .download-btn {
            background: #0C0E8B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: #1416a0;
        }
        /* Add new styles for meal sets */
        .meal-sets {
            display: none;
            margin: 20px 0;
        }

        .meal-set-option {
            background: white;
            border: 2px solid #0C0E8B;
            color: #0C0E8B;
            padding: 15px 25px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .meal-set-option:hover {
            background: #0C0E8B;
            color: white;
        }

        .meal-set-option.selected {
            background: #0C0E8B;
            color: white;
        }

        .meal-set-title {
            font-size: 1.2rem;
            color: #0C0E8B;
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Rest of the previous styles remain the same */
    </style>
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="overlay" id="overlay"></div>

    <!-- Header -->
    <div class="header">
        <img src="pictures/new.png" alt="App Logo">
    </div>

    <div class="container">
        <!-- Calendar Section -->
        <div class="calendar-container">
            <h2>Today's Date</h2>
            <div id="calendar"></div>
        </div>
		</div>
<div class="container">
        <!-- Order Section -->
        <div class="order-section">
            <p class="order-question">Do you want to order food today?</p>
            <div class="order-buttons">
                <button class="yes-btn" onclick="handleYesClick()">Yes</button>
                <button class="no-btn" onclick="handleNoClick()">No</button>
            </div>
            
            <!-- Meal sets section -->
            <div class="meal-sets" id="mealSets">
                <p class="meal-set-title">Please select A OR B </p>
                <button class="meal-set-option" data-set="A">( A ) NON-MUSLIM , অমুসলিম ,गैर-मुस्लिम</button>
                <button class="meal-set-option" data-set="B">( B ) MUSLIM , মুসলিম, मुस्लिम</button>
            </div>

            <button id="submitOrder">Submit Order</button>
            <p id="time-message"></p>
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>
    
	</div>

   <!-- Thank You Message with QR Code -->
    <div class="thank-you-container" id="thankYouMessage">
        <i class="fas fa-check-circle"></i>
        <h2>Thank You!</h2>
        <p>Your order has been successfully placed.</p>
        <!-- Added meal set display here -->
        <div class="meal-set-display" id="mealSetDisplay">
            Your Selected Meal: <span id="selectedMealText"></span>
        </div>
        <div id="qrcode"></div>
        <p class="qr-instruction">Show this QR code when collecting your food</p>
        <button class="download-btn" id="downloadQR">Download QR Code</button>
    </div>
    <!-- Floating Menu -->
    <div class="floating-menu" id="floatingMenu">
        <a href="about.html" class="menu-item">
            <i class="fas fa-circle"></i>
            <span>About Us</span>
        </a>
        <a href="contactus_pg.html" class="menu-item">
            <i class="fas fa-phone"></i>
            <span>Contact us</span>
        </a>
        <a href="feedback.html" class="menu-item">
            <i class="fas fa-file-alt"></i>
            <span>Feedback</span>
        </a>
    </div>

   <!-- Bottom Navigation -->
    <div class="nav-container">
         <a href="home.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
		</a>
		 <a href="profile_pg.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
      
        <button class="plus-button" id="plusButton">
            <i class="fas fa-plus"></i>
        </button>
        
        <a href="order_pg.html" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Order</span>
        </a>   
		 <a href="menu_pg.html" class="nav-item">
            <i class="fas fa-book"></i>
            <span>Menu</span>
        </a>
    </div>
	


    <script type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const firebaseConfig = {
   apiKey: "AIzaSyA_eTabpa9spioE_pGOJUZ-wRM4rIvLKGA",
  authDomain: "suria-food-ordering-system.firebaseapp.com",
  projectId: "suria-food-ordering-system",
  storageBucket: "suria-food-ordering-system.firebasestorage.app",
  messagingSenderId: "204528329291",
  appId: "1:204528329291:web:cba270a2968e6d159963ce"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const submitButton = document.getElementById('submitOrder');
const thankYouMessage = document.getElementById('thankYouMessage');
const overlay = document.getElementById('overlay');
const loadingSpinner = document.getElementById('loadingSpinner');
const timeMessage = document.getElementById('time-message');
const calendarElement = document.getElementById('calendar');
const plusButton = document.getElementById('plusButton');
const floatingMenu = document.getElementById('floatingMenu');
const mealSetsContainer = document.getElementById('mealSets');
const selectedMealText = document.getElementById('selectedMealText');
const mealSetDisplay = document.getElementById('mealSetDisplay');
let selectedMealSet = null;

// Function to get server time
async function getCurrentServerTime() {
    try {
        // Create a temporary document to get the server timestamp
        const timestampRef = await addDoc(collection(db, "timestamps"), {
            timestamp: serverTimestamp()
        });
        
        // Get the document with the server timestamp
        const timestampDoc = await getDoc(timestampRef);
        const serverTime = timestampDoc.data().timestamp.toDate();
        
        // Delete the temporary document (cleanup)
        await deleteDoc(timestampRef);
        
        return serverTime;
    } catch (error) {
        console.error("Error getting server time:", error);
        // Fallback to local time only if server time fails
        return new Date();
    }
}

// Function to display meal set text
function displayMealSetText(mealSet) {
    if (mealSet === 'A') {
        selectedMealText.textContent = "Set A (NON-MUSLIM)";
        mealSetDisplay.style.display = 'block';
    } else if (mealSet === 'B') {
        selectedMealText.textContent = "Set B (MUSLIM)";
        mealSetDisplay.style.display = 'block';
    } else {
        mealSetDisplay.style.display = 'none';
    }
}

// Set up calendar with server time
async function updateCalendarDisplay() {
    const today = await getCurrentServerTime();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    calendarElement.textContent = today.toLocaleDateString('en-US', options);
}

// Check if current time is within ordering hours
async function isOrderingTime() {
    const currentTime = await getCurrentServerTime();
    const morningStart = new Date(currentTime).setHours(6, 0, 0, 0);
    const morningEnd = new Date(currentTime).setHours(10, 0, 0, 0);
    const eveningStart = new Date(currentTime).setHours(19, 0, 0, 0);
    const eveningEnd = new Date(currentTime).setHours(21, 0, 0, 0);
    
    return {
        isValid: (currentTime >= morningStart && currentTime <= morningEnd) || 
                (currentTime >= eveningStart && currentTime <= eveningEnd),
        isMorningShift: currentTime >= morningStart && currentTime <= morningEnd,
        isNightShift: currentTime >= eveningStart && currentTime <= eveningEnd
    };
}

function displayTimeMessage(message) {
    timeMessage.textContent = message;
    timeMessage.style.display = 'block';
}

function storeOrderData(orderData) {
    // Convert any Firestore timestamps to strings before storing
    const orderToStore = {
        ...orderData,
        orderDate: orderData.orderDate && typeof orderData.orderDate.toDate === 'function' 
            ? orderData.orderDate.toDate().toISOString() 
            : orderData.orderDate,
        orderTimestamp: new Date().toISOString() // Ensure we always have a timestamp string
    };
    
    localStorage.setItem('orderData', JSON.stringify(orderToStore));
    localStorage.setItem('orderDate', new Date().toISOString());
}

async function isStoredOrderFromToday() {
    const storedDate = localStorage.getItem('orderDate');
    if (!storedDate) return false;

    const currentDate = await getCurrentServerTime();
    const storedDateTime = new Date(storedDate);

    return storedDateTime.getDate() === currentDate.getDate() &&
           storedDateTime.getMonth() === currentDate.getMonth() &&
           storedDateTime.getFullYear() === currentDate.getFullYear();
}

function clearStoredOrderData() {
    localStorage.removeItem('orderData');
    localStorage.removeItem('orderDate');
}

function setupMealSetSelection() {
    const mealSetOptions = document.querySelectorAll('.meal-set-option');
    mealSetOptions.forEach(option => {
        option.addEventListener('click', () => {
            mealSetOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');

            selectedMealSet = option.dataset.set;
            submitButton.style.display = 'inline-block';
        });
    });
}

async function getOrderDetails(orderRef) {
    try {
        const orderDoc = await getDoc(orderRef);
        if (orderDoc.exists()) {
            const fullData = orderDoc.data();
            return {
                employeeId: fullData.employeeId,
                orderDate: fullData.orderDate,
                orderTimestamp: fullData.orderDate ? fullData.orderDate.toDate().toISOString() : null,
                orderStatus: fullData.orderStatus,
                mealSet: fullData.mealSet
            };
        }
        throw new Error("Order not found");
    } catch (error) {
        console.error("Error getting order details:", error);
        return null;
    }
}

function generateQRCode(data) {
    console.log("Generating QR code with data:", data);
    const qrContainer = document.getElementById('qrcode');
    
    if (!qrContainer) {
        console.error("QR code container not found!");
        return;
    }
    
    qrContainer.innerHTML = '';
    
    // Ensure all data is in string format for QR code
    const qrData = {
        employeeId: data.employeeId || '',
        orderDate: typeof data.orderDate === 'string' ? data.orderDate : 
                   (data.orderDate instanceof Date ? data.orderDate.toISOString() : 
                   (data.orderDate && typeof data.orderDate.toDate === 'function' ? 
                    data.orderDate.toDate().toISOString() : new Date().toISOString())),
        orderTimestamp: data.orderTimestamp || new Date().toISOString(),
        orderStatus: data.orderStatus || 'ordered',
        mealSet: data.mealSet || ''
    };

    // Display meal set information
    displayMealSetText(data.mealSet);

    try {
        new QRCode(qrContainer, {
            text: JSON.stringify(qrData),
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        const downloadBtn = document.getElementById('downloadQR');
        if (downloadBtn) {
            downloadBtn.style.display = 'block';
            downloadBtn.onclick = () => {
                const canvas = qrContainer.querySelector('canvas');
                if (canvas) {
                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `order-qr-${new Date().getTime()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    console.error("Canvas element not found in QR container");
                }
            };
        } else {
            console.error("Download button not found");
        }
    } catch (error) {
        console.error("Error generating QR code:", error);
    }
}

async function checkPreviousOrder(userID, collectionRef) {
    try {
        const todayStart = await getCurrentServerTime();
        todayStart.setHours(0, 0, 0, 0);
        const q = query(
            collectionRef, 
            where("userId", "==", userID),
    
        );
        const querySnapshot = await getDocs(q);
        return querySnapshot.empty;
    } catch (error) {
        console.error("Error checking previous entries:", error);
        return true;
    }
}

async function processOrder(userID) {
    try {
        const timeStatus = await isOrderingTime();
        if (!timeStatus.isValid) {
            alert("Order is closed. Please order between 6 AM - 10 AM or 7 PM - 9 PM.");
            return;
        }

        if ((timeStatus.isMorningShift || timeStatus.isNightShift) && !selectedMealSet) {
            alert("Please select a meal set before submitting your order.");
            return;
        }

        const hasNoPreviousOrder = await checkPreviousOrder(userID, collection(db, "orders"));
        if (!hasNoPreviousOrder) {
            alert("You have already placed an order today.");
            return;
        }

        overlay.style.display = 'block';
        loadingSpinner.style.display = 'block';

        const userDoc = await getDoc(doc(db, "users", userID));
        if (!userDoc.exists()) throw new Error("Could not get user info");

        const userData = userDoc.data();
        const orderDetails = {
            ...userData,
            orderDate: serverTimestamp(), // Server-side timestamp
            userId: userID,
            orderStatus: "ordered",
            mealSet: selectedMealSet
        };

        const orderRef = await addDoc(collection(db, "orders"), orderDetails);
        
        // Get the order with the populated server timestamp
        const orderSnapshot = await getDoc(orderRef);
        const orderWithTimestamp = {
            ...orderSnapshot.data(),
            id: orderRef.id
        };
        
        thankYouMessage.style.display = 'block';
        generateQRCode(orderWithTimestamp);
        submitButton.style.display = 'none';
        storeOrderData(orderWithTimestamp);
    } catch (error) {
        console.error("Error processing order:", error);
        alert("There was an error processing your order. Please try again.");
        thankYouMessage.style.display = 'none';
    } finally {
        overlay.style.display = 'none';
        loadingSpinner.style.display = 'none';
    }
}

// Handle Yes Click
window.handleYesClick = async function() {
    const user = auth.currentUser;
    if (!user) {
        alert("Please log in to continue");
        return;
    }

    const timeStatus = await isOrderingTime();
    if (!timeStatus.isValid) {
        displayTimeMessage("Order is closed. Please order between 6 AM - 10 AM or 7 PM - 9 PM.");
        submitButton.style.display = 'none';
        return;
    }

    const hasNoPreviousOrder = await checkPreviousOrder(user.uid, collection(db, "orders"));
    if (!hasNoPreviousOrder) {
        displayTimeMessage("You have already placed an order today.");
        submitButton.style.display = 'none';
        return;
    }

    // Show meal set selection for both morning and night shifts
    if (timeStatus.isMorningShift || timeStatus.isNightShift) {
        mealSetsContainer.style.display = 'block';
        submitButton.style.display = 'none';
        displayTimeMessage("Please select your meal set.");
        setupMealSetSelection();
    } else {
        submitButton.style.display = 'inline-block';
        displayTimeMessage("You can place an order.");
    }
};

// Handle No Click
window.handleNoClick = async function() {
    const user = auth.currentUser;
    if (!user) {
        alert("Please log in to continue");
        return;
    }

    const timeStatus = await isOrderingTime();
    if (!timeStatus.isValid) {
        displayTimeMessage("'No Eating' submission is only available between 6 AM - 10 AM or 7 PM - 9 PM.");
        return;
    }

    const noEatingCollection = collection(db, "noEating");
    const hasNoPreviousNoEating = await checkPreviousOrder(user.uid, noEatingCollection);
    
    if (!hasNoPreviousNoEating) {
        alert("You have already submitted a 'No Eating' entry today.");
        return;
    }

    const confirmDialog = document.createElement('div');
    confirmDialog.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;justify-content:center;align-items:center;">
            <div style="background:white;padding:20px;border-radius:10px;text-align:center;">
                <p style="margin-bottom:20px;">Are you sure you don't want to order food today?</p>
                <button id="confirmYes" style="margin:0 10px;padding:8px 16px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;">Yes</button>
                <button id="confirmNo" style="margin:0 10px;padding:8px 16px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;">No</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmDialog);

    const handleConfirmation = async (confirmed) => {
        if (confirmed) {
            try {
                overlay.style.display = 'block';
                loadingSpinner.style.display = 'block';

                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists()) throw new Error("Could not get user info");

                const userData = userDoc.data();
                const noEatingDetails = {
                    ...userData,
                    userId: user.uid,
                    noEatingDate: serverTimestamp()
                };

                await addDoc(noEatingCollection, noEatingDetails);
                alert('Thank you for letting us know!');
                window.location.href = 'home.html';
            } catch (error) {
                console.error("Error processing no eating option:", error);
                alert("There was an error. Please try again.");
            } finally {
                overlay.style.display = 'none';
                loadingSpinner.style.display = 'none';
            }
        }
        confirmDialog.remove();
    };

    confirmDialog.querySelector('#confirmYes').addEventListener('click', () => handleConfirmation(true));
    confirmDialog.querySelector('#confirmNo').addEventListener('click', () => handleConfirmation(false));
};

// Function to check if user has an existing order and display it
async function checkAndDisplayExistingOrder(userID) {
    if (await isStoredOrderFromToday()) {
        try {
            const orderDataString = localStorage.getItem('orderData');
            if (!orderDataString) {
                console.error("No order data found in localStorage");
                return false;
            }
            
            const orderData = JSON.parse(orderDataString);
            console.log("Retrieved order data from localStorage:", orderData);
            
            if (orderData && orderData.userId === userID) {
                // Display the stored QR code
                thankYouMessage.style.display = 'block';
                submitButton.style.display = 'none';
                
                // Ensure the QR code element exists before generating
                setTimeout(() => {
                    generateQRCode(orderData);
                }, 300); // Small delay to ensure DOM is ready
                
                return true;
            }
        } catch (error) {
            console.error("Error displaying stored order:", error);
        }
    }
    return false;
}

// Function to restore order display when page loads
async function restoreOrderDisplay() {
    console.log("Restoring order display...");
    if (await isStoredOrderFromToday()) {
        try {
            const orderDataString = localStorage.getItem('orderData');
            if (!orderDataString) {
                console.error("No order data found in localStorage");
                return;
            }
            
            const orderData = JSON.parse(orderDataString);
            console.log("Retrieved order data from localStorage:", orderData);
            
            if (orderData) {
                // Display the stored QR code without waiting for auth
                thankYouMessage.style.display = 'block';
                submitButton.style.display = 'none';
                
                // Ensure the QR code generation happens after DOM is fully loaded
                setTimeout(() => {
                    if (document.getElementById('qrcode')) {
                        generateQRCode(orderData);
                    } else {
                        console.error("QR code container not found!");
                    }
                }, 500); // Delay to ensure DOM is ready
            }
        } catch (error) {
            console.error("Error restoring order display:", error);
        }
    } else {
        console.log("No order from today found");
    }
}

// Event Listeners
if (submitButton) {
    submitButton.addEventListener("click", () => {
        auth.onAuthStateChanged((user) => {
            if (user) {
                processOrder(user.uid);
            } else {
                alert("Please log in to place an order");
            }
        });
    });
}

auth.onAuthStateChanged((user) => {
    if (user) checkAndDisplayExistingOrder(user.uid);
});

if (plusButton) {
    plusButton.addEventListener('click', () => {
        plusButton.classList.toggle('active');
        floatingMenu.classList.toggle('active');
    });
}

document.addEventListener('click', (e) => {
    if (plusButton && floatingMenu && !plusButton.contains(e.target) && !floatingMenu.contains(e.target)) {
        plusButton.classList.remove('active');
        floatingMenu.classList.remove('active');
    }
});

// Initialize the page with server time
document.addEventListener('DOMContentLoaded', async () => {
    console.log("DOM content loaded");
    
    // Make sure QR code library is loaded
    if (typeof QRCode === 'undefined') {
        console.error("QR Code library not loaded!");
        
        // Try to load QR code library dynamically if needed
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
        script.onload = async () => {
            console.log("QR Code library loaded dynamically");
            await updateCalendarDisplay();
            await restoreOrderDisplay();
        };
        script.onerror = () => {
            console.error("Failed to load QR Code library dynamically");
        };
        document.head.appendChild(script);
    } else {
        await updateCalendarDisplay();
        await restoreOrderDisplay();
    }
});

// Check every minute if we need to clear the display
setInterval(async () => {
    const now = await getCurrentServerTime();
    const endOfDay = new Date(now);
    endOfDay.setHours(23, 59, 59, 999);
    
    // If it's past 11:59 PM and the order is not from today
    if (now >= endOfDay && !(await isStoredOrderFromToday())) {
        clearStoredOrderData();
        location.reload();
    }
}, 60000);
    </script>
</body>
</html>